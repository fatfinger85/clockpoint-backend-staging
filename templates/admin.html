
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ClockPoint - Panel Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .nav-tabs .nav-link.active { background-color: #0d6efd; color: white; }
    .nav-tabs .nav-link { color: #0d6efd; }
    .card { border-radius: 12px; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.05); }
    .table { border-radius: 8px; overflow: hidden; }
    th { background-color: #e9ecef; }
    #admin-alert-placeholder { min-height: 50px; /* Prevent layout shift */}
    @media (max-width: 576px) {
      .card { padding: 20px; }
      .nav-tabs .nav-link { font-size: 0.9rem; padding: 0.5rem; }
      .table-responsive { overflow-x: auto; }
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="card p-4">
      <h2 class="text-center mb-4 text-primary">Panel de AdministraciÃ³n</h2>

      <div id="admin-alert-placeholder"></div>

      <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab">ðŸ•“ Historial</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="empleados-tab" data-bs-toggle="tab" data-bs-target="#empleados" type="button" role="tab">âž• Agregar Empleado</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="gestion-tab" data-bs-toggle="tab" data-bs-target="#gestion" type="button" role="tab">ðŸ‘¥ Gestionar Empleados</button>
        </li>
        <li class="nav-item">
          <a class="nav-link text-success" href="/exportar" target="_blank">ðŸ“¤ Exportar CSV</a>
        </li>
      </ul>

      <div class="tab-content mt-4" id="adminTabsContent">
        <div class="tab-pane fade show active" id="historial" role="tabpanel">
          <div class="table-responsive" id="tablaHistorial">Cargando historial...</div>
        </div>
        <div class="tab-pane fade" id="empleados" role="tabpanel">
          <form id="add-employee-form" action="/agregar-empleado" method="POST" class="mt-3 row g-2">
            <div class="col-md-5">
              <input type="text" name="nombre" placeholder="Nombre" required class="form-control" aria-label="Nombre del nuevo empleado">
            </div>
            <div class="col-md-5">
              <input type="text" name="pin" pattern="\d*" title="PIN debe ser numÃ©rico" placeholder="PIN (solo nÃºmeros)" required class="form-control" aria-label="PIN del nuevo empleado"> </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-primary w-100">Agregar</button>
            </div>
          </form>
        </div>
        <div class="tab-pane fade" id="gestion" role="tabpanel">
          <div class="table-responsive" id="tablaEmpleados" class="mt-3">Cargando empleados...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteConfirmModalLabel">Confirmar EliminaciÃ³n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Â¿EstÃ¡s seguro de que quieres eliminar al empleado <strong id="employeeNameToDelete"></strong>? Esta acciÃ³n no se puede deshacer.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Eliminar</button>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const tablaHistorial = document.getElementById("tablaHistorial");
    const tablaEmpleados = document.getElementById("tablaEmpleados");
    const adminAlertPlaceholder = document.getElementById('admin-alert-placeholder');
    let deleteConfirmModal = null; // Initialize modal variable
    let employeeToDelete = null;   // Store name of employee to delete

    // --- Alert Helper ---
    function showAdminAlert(message, type = 'danger') {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = [
        `<div class="alert alert-${type} alert-dismissible fade show" role="alert">`,
        `   <div>${message}</div>`,
        '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
        '</div>'
      ].join('');
      adminAlertPlaceholder.innerHTML = ''; // Clear previous alerts
      adminAlertPlaceholder.append(wrapper);
    }
    function clearAdminAlert() {
        adminAlertPlaceholder.innerHTML = '';
    }

    // --- Data Loading Functions ---
    async function cargarHistorial() {
      tablaHistorial.innerHTML = 'Cargando historial...';
      try {
          const res = await fetch('/registros');
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const data = await res.json();

          if (data.error) {
              throw new Error(data.error);
          }

          if (data.length === 0) {
              tablaHistorial.innerHTML = '<p class="text-muted text-center">No hay registros de historial.</p>';
              return;
          }

          let html = "<table class='table table-bordered table-striped table-hover'><thead><tr><th>Nombre</th><th>AcciÃ³n</th><th>Fecha y Hora (Central Time)</th></tr></thead><tbody>";
          data.forEach(r => {
            // Basic sanitation or ensure data is safe if sourced externally
            const nombre = r.nombre || '';
            const accion = r.accion || '';
            const timestamp = r.timestamp || '';
            html += `<tr><td>${escapeHtml(nombre)}</td><td>${escapeHtml(accion)}</td><td>${escapeHtml(timestamp)}</td></tr>`;
          });
          html += "</tbody></table>";
          tablaHistorial.innerHTML = html;
      } catch (error) {
          console.error("Error loading history:", error);
          tablaHistorial.innerHTML = `<div class="alert alert-danger">Error al cargar el historial: ${error.message}</div>`;
      }
    }

    async function cargarEmpleados() {
      tablaEmpleados.innerHTML = 'Cargando empleados...';
      try {
          const res = await fetch('/empleados');
           if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const data = await res.json();

           if (data.error) {
              throw new Error(data.error);
          }

           if (data.length === 0) {
              tablaEmpleados.innerHTML = '<p class="text-muted text-center">No hay empleados registrados.</p>';
              return;
          }

          let html = "<table class='table table-bordered table-hover'><thead><tr><th>Nombre</th><th>PIN</th><th>Acciones</th></tr></thead><tbody>";
          data.forEach(e => {
            const nombre = e.nombre || '';
            const pin = e.pin || ''; // Be careful about displaying PINs, even in admin
            html += `<tr>
                      <td>${escapeHtml(nombre)}</td>
                      <td>${escapeHtml(pin)}</td>
                      <td><button class='btn btn-sm btn-danger' onclick="confirmDeleteEmployee('${escapeHtml(nombre)}')">Eliminar</button></td>
                    </tr>`;
          });
          html += "</tbody></table>";
          tablaEmpleados.innerHTML = html;
      } catch (error) {
          console.error("Error loading employees:", error);
          tablaEmpleados.innerHTML = `<div class="alert alert-danger">Error al cargar los empleados: ${error.message}</div>`;
      }
    }

    // --- Delete Employee Logic ---
    function confirmDeleteEmployee(nombre) {
        employeeToDelete = nombre; // Store the name
        document.getElementById('employeeNameToDelete').textContent = nombre; // Update modal text
        if (deleteConfirmModal) {
            deleteConfirmModal.show(); // Show the modal
        }
    }

    async function performDelete() {
        if (!employeeToDelete) return;

        clearAdminAlert();
        try {
            const response = await fetch('/eliminar-empleado', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre: employeeToDelete })
            });
            const result = await response.json();

            if (response.ok && result.status === 'success') {
                showAdminAlert(`Empleado '${employeeToDelete}' eliminado correctamente.`, 'success');
                cargarEmpleados(); // Refresh the employee list
            } else {
                throw new Error(result.message || 'Error desconocido al eliminar');
            }
        } catch (error) {
            console.error("Error deleting employee:", error);
            showAdminAlert(`Error al eliminar empleado: ${error.message}`, 'danger');
        } finally {
             if (deleteConfirmModal) {
                deleteConfirmModal.hide(); // Hide modal regardless of outcome
             }
            employeeToDelete = null; // Reset stored name
        }
    }

    // --- Add Employee Form Handling ---
    document.getElementById('add-employee-form').addEventListener('submit', async function(event) {
        event.preventDefault(); // Prevent default form submission
        clearAdminAlert();

        const formData = new FormData(this);
        const nombre = formData.get('nombre');
        const pin = formData.get('pin');

        // Basic client-side validation (complementing server-side)
        if (!nombre || !pin) {
            showAdminAlert('Nombre y PIN son requeridos.', 'warning');
            return;
        }
         if (!/^\d+$/.test(pin)) {
            showAdminAlert('PIN debe ser numÃ©rico.', 'warning');
            return;
        }

        try {
            const response = await fetch('/agregar-empleado', {
                method: 'POST',
                body: formData // Send form data directly
            });

            // Check if redirect indicates success (status 200 after redirect)
            // Or handle potential error messages returned directly
            if (response.ok && response.redirected) {
                 showAdminAlert(`Empleado '${nombre}' agregado correctamente.`, 'success');
                 this.reset(); // Clear the form
                 cargarEmpleados(); // Refresh list
                 // Optionally switch tab: new bootstrap.Tab(document.getElementById('gestion-tab')).show();
            } else {
                // Try to read error text from response if not redirected
                const errorText = await response.text();
                throw new Error(errorText || `Error ${response.status} al agregar empleado.`);
            }
        } catch (error) {
             console.error("Error adding employee:", error);
             showAdminAlert(`Error al agregar empleado: ${error.message}`, 'danger');
        }
    });

     // --- Utility Function ---
     function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return '';
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
     }


    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize the modal instance
        deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

        // Attach the delete action to the modal's confirm button
        document.getElementById('confirmDeleteBtn').addEventListener('click', performDelete);

        // Initial data load
        cargarHistorial();
        cargarEmpleados();

        // Check for success/error messages from redirects (e.g., after adding employee)
        const urlParams = new URLSearchParams(window.location.search);
        const successMsg = urlParams.get('success');
        const errorMsg = urlParams.get('error');
        if (successMsg) {
            showAdminAlert(successMsg, 'success');
            // Clean the URL
            window.history.replaceState({}, document.title, window.location.pathname);
        } else if (errorMsg) {
             showAdminAlert(errorMsg, 'danger');
              window.history.replaceState({}, document.title, window.location.pathname);
        }
    });


  </script>
</body>
</html>
