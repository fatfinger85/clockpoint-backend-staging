
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ClockPoint - Panel Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Estilos personalizados (idealmente extraer a styles.css) -->
  <style>
    body { background-color: #f8f9fa; }
    .nav-tabs .nav-link.active { background-color: #0d6efd; color: #fff; }
    .nav-tabs .nav-link { color: #0d6efd; }
    .card { border-radius: 12px; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.05); }
    .table { border-radius: 8px; overflow: hidden; }
    th { background-color: #e9ecef; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="card p-4">
      <h2 class="text-center mb-4 text-primary">Panel de Administraci√≥n</h2>

      <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab" aria-label="Pesta√±a Historial">üïì Historial</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="empleados-tab" data-bs-toggle="tab" data-bs-target="#empleados" type="button" role="tab" aria-label="Pesta√±a Agregar Empleado">‚ûï Agregar Empleado</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="gestion-tab" data-bs-toggle="tab" data-bs-target="#gestion" type="button" role="tab" aria-label="Pesta√±a Gestionar Empleados">üë• Gestionar Empleados</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="proyectos-tab" data-bs-toggle="tab" data-bs-target="#proyectos" type="button" role="tab" aria-label="Pesta√±a Proyectos">üèóÔ∏è Proyectos</button>
        </li>
        <li class="nav-item">
          <a class="nav-link text-success" href="/exportar" target="_blank" aria-label="Exportar CSV">üì§ Exportar CSV</a>
        </li>
      </ul>

      <div class="tab-content mt-4" id="adminTabsContent">
        <div class="tab-pane fade show active" id="historial" role="tabpanel">
          <div id="tablaHistorial">Cargando historial...</div>
        </div>
        <div class="tab-pane fade" id="empleados" role="tabpanel">
          <form action="/agregar-empleado" method="POST" class="mt-3 row g-2" id="formAgregarEmpleado">
            <div class="col-md-5">
              <input type="text" name="nombre" placeholder="Nombre" required class="form-control">
            </div>
            <div class="col-md-5">
              <input type="text" name="pin" placeholder="PIN" required class="form-control">
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-primary w-100">Agregar</button>
            </div>
          </form>
        </div>
        <div class="tab-pane fade" id="gestion" role="tabpanel">
          <div id="tablaEmpleados" class="mt-3">Cargando empleados...</div>
        </div>
        <div class="tab-pane fade" id="proyectos" role="tabpanel">
          <form id="formProyecto" class="mt-3 row g-2">
            <div class="col-md-10">
              <input type="text" id="nombreProyecto" placeholder="Nombre del Proyecto" required class="form-control">
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-success w-100">Agregar</button>
            </div>
          </form>
          <div id="tablaProyectos" class="mt-4">Cargando proyectos...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Muestra un spinner en el contenedor dado
    function showSpinner(containerId) {
      document.getElementById(containerId).innerHTML = `
        <div class="text-center py-3">
          <div class="spinner-border" role="status"><span class="visually-hidden">Cargando...</span></div>
        </div>`;
    }

    // Carga el historial de registros, incluyendo nombre del proyecto
    async function cargarHistorial() {
      showSpinner('tablaHistorial');
      try {
        // Obtener registros y proyectos
        const [resReg, resProj] = await Promise.all([
          fetch('/registros'),
          fetch('/proyectos')
        ]);
        if (!resReg.ok) throw new Error('Error al obtener registros');
        if (!resProj.ok) throw new Error('Error al obtener proyectos');

        const registros = await resReg.json();
        const proyectos = await resProj.json();

        // Mapa de proyectos por id
        const mapaProyectos = {};
        proyectos.forEach(p => { mapaProyectos[p.id] = p.nombre; });

        // Construir tabla con columna Proyecto
        let html = `
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Acci√≥n</th>
                <th>Proyecto</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody>
        `;
        registros.forEach(r => {
          const nombreProyecto = mapaProyectos[r.proyecto_id] || '‚Äî';
          html += `
            <tr>
              <td>${r.nombre}</td>
              <td>${r.accion}</td>
              <td>${nombreProyecto}</td>
              <td>${r.timestamp}</td>
            </tr>
          `;
        });
        html += `</tbody></table>`;

        document.getElementById('tablaHistorial').innerHTML = html;
      } catch (err) {
        document.getElementById('tablaHistorial').innerHTML =
          `<div class="alert alert-danger">Error cargando historial: ${err.message}</div>`;
      }
    }

    // Resto de funciones id√©nticas
    async function cargarEmpleados() {
      showSpinner('tablaEmpleados');
      try {
        const res = await fetch('/empleados');
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        let html = "<table class='table table-bordered table-hover'><thead><tr><th>Nombre</th><th>PIN</th><th>Eliminar</th></tr></thead><tbody>";
        data.forEach(e => {
          html += `<tr><td>${e.nombre}</td><td>${e.pin}</td><td><button class='btn btn-sm btn-danger' onclick="eliminarEmpleado('${e.nombre}')">Eliminar</button></td></tr>`;
        });
        html += "</tbody></table>";
        document.getElementById('tablaEmpleados').innerHTML = html;
      } catch (err) {
        document.getElementById('tablaEmpleados').innerHTML = `<div class='alert alert-danger'>Error cargando empleados: ${err.message}</div>`;
      }
    }

    async function eliminarEmpleado(nombre) {
      if (!confirm(`¬øEliminar a ${nombre}?`)) return;
      try {
        const res = await fetch('/eliminar-empleado', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre })
        });
        if (!res.ok) throw new Error(res.statusText);
      } catch (err) {
        alert(`Error eliminando empleado: ${err.message}`);
      }
      cargarEmpleados();
    }

    async function cargarProyectos() {
      showSpinner('tablaProyectos');
      try {
        const res = await fetch('/proyectos');
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        let html = "<table class='table table-bordered'><thead><tr><th>Nombre del Proyecto</th></tr></thead><tbody>";
        data.forEach(p => { html += `<tr><td>${p.nombre}</td></tr>`; });
        html += "</tbody></table>";
        document.getElementById('tablaProyectos').innerHTML = html;
      } catch (err) {
        document.getElementById('tablaProyectos').innerHTML = `<div class='alert alert-danger'>Error cargando proyectos: ${err.message}</div>`;
      }
    }

    document.getElementById('formProyecto').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nombre = document.getElementById('nombreProyecto').value.trim();
      if (!nombre) return;
      try {
        const res = await fetch('/agregar-proyecto', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre }) });
        if (!res.ok) throw new Error(res.statusText);
        e.target.reset();
        cargarProyectos();
      } catch (err) {
        alert(`Error al agregar proyecto: ${err.message}`);
      }
    });

    document.querySelector('#historial-tab').addEventListener('shown.bs.tab', cargarHistorial);
    document.querySelector('#empleados-tab').addEventListener('shown.bs.tab', cargarEmpleados);
    document.querySelector('#gestion-tab').addEventListener('shown.bs.tab', cargarEmpleados);
    document.querySelector('#proyectos-tab').addEventListener('shown.bs.tab', cargarProyectos);

    cargarHistorial();
  </script>
</body>
</html>
