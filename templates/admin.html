
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ClockPoint - Panel Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .nav-tabs .nav-link.active { background-color: #0d6efd; color: white; }
    .nav-tabs .nav-link { color: #0d6efd; cursor: pointer; } /* Added cursor pointer */
    .card { border-radius: 12px; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.05); }
    .table { border-radius: 8px; overflow: hidden; }
    th { background-color: #e9ecef; }
    #admin-alert-placeholder { min-height: 50px; /* Prevent layout shift */}
    .table button { margin-left: 5px; } /* Spacing for buttons in tables */
    @media (max-width: 576px) {
      .card { padding: 20px; }
      .nav-tabs .nav-link { font-size: 0.9rem; padding: 0.5rem; }
      .table-responsive { overflow-x: auto; }
      #add-project-form .btn, #add-employee-form .btn { margin-top: 0.5rem; } /* Stack button below inputs */
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="card p-4">
      <h2 class="text-center mb-4 text-primary">Panel de Administraci√≥n</h2>

      <div id="admin-alert-placeholder"></div>

      <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab">üïì Historial</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="empleados-tab" data-bs-toggle="tab" data-bs-target="#empleados" type="button" role="tab">‚ûï Agregar Empleado</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="gestion-tab" data-bs-toggle="tab" data-bs-target="#gestion" type="button" role="tab">üë• Gestionar Empleados</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="proyectos-tab" data-bs-toggle="tab" data-bs-target="#proyectos" type="button" role="tab">üìÅ Proyectos</button>
        </li>
        <li class="nav-item ms-auto"> <a class="nav-link text-success" href="/exportar" target="_blank">üì§ Exportar CSV</a>
        </li>
      </ul>

      <div class="tab-content mt-4" id="adminTabsContent">
        <div class="tab-pane fade show active" id="historial" role="tabpanel">
          <div class="table-responsive" id="tablaHistorial">Cargando historial...</div>
        </div>
        <div class="tab-pane fade" id="empleados" role="tabpanel">
          <form id="add-employee-form" action="/agregar-empleado" method="POST" class="mt-3 row g-2">
            <div class="col-md-5">
              <input type="text" name="nombre" placeholder="Nombre Empleado" required class="form-control" aria-label="Nombre del nuevo empleado">
            </div>
            <div class="col-md-5">
              <input type="text" name="pin" pattern="\d*" title="PIN debe ser num√©rico" placeholder="PIN (solo n√∫meros)" required class="form-control" aria-label="PIN del nuevo empleado">
            </div>
            <div class="col-md-2 d-grid">
              <button type="submit" class="btn btn-primary">Agregar</button>
            </div>
          </form>
        </div>
        <div class="tab-pane fade" id="gestion" role="tabpanel">
          <div class="table-responsive" id="tablaEmpleados" class="mt-3">Cargando empleados...</div>
        </div>

        <div class="tab-pane fade" id="proyectos" role="tabpanel">
          <h4 class="mb-3">Gestionar Proyectos</h4>
          <form id="add-project-form" action="/agregar-proyecto" method="POST" class="mb-4 row g-2">
            <div class="col-md-10">
              <input type="text" name="nombre_proyecto" placeholder="Nombre del Nuevo Proyecto" required class="form-control" aria-label="Nombre del nuevo proyecto">
            </div>
            <div class="col-md-2 d-grid">
              <button type="submit" class="btn btn-primary">Agregar Proyecto</button>
            </div>
          </form>
          <div class="table-responsive" id="tablaProyectos">Cargando proyectos...</div>
        </div>

      </div>
    </div>
  </div>

  <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- DOM Elements ---
    const tablaHistorial = document.getElementById("tablaHistorial");
    const tablaEmpleados = document.getElementById("tablaEmpleados");
    const tablaProyectos = document.getElementById("tablaProyectos");
    const adminAlertPlaceholder = document.getElementById('admin-alert-placeholder');
    const itemNameToDeleteSpan = document.getElementById('itemNameToDelete');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    let deleteConfirmModal = null;
    let deleteAction = null;

    // --- Alert Helper ---
    function showAdminAlert(message, type = 'danger') { /* ... keep existing code ... */ }
    function clearAdminAlert() { /* ... keep existing code ... */ }

    // --- Data Loading ---

    // --- MODIFIED: Load History ---
    async function cargarHistorial() {
      tablaHistorial.innerHTML = 'Cargando historial...';
      try {
          const res = await fetch('/registros'); // Fetches records from backend
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const data = await res.json();

         console.log("Data received from /registros:", data);

          if (data.error) { throw new Error(data.error); }
          if (data.length === 0) {
              tablaHistorial.innerHTML = '<p class="text-muted text-center">No hay registros de historial.</p>'; return;
          }

          // --- Add 'Proyecto' column header ---
          let html = "<table class='table table-bordered table-striped table-hover'><thead><tr><th>Nombre</th><th>Acci√≥n</th><th>Fecha y Hora (Central Time)</th><th>Proyecto</th></tr></thead><tbody>"; // Added <th>Proyecto</th>

          data.forEach(r => {
            // Safely get data, providing default empty strings
            const nombre = r.nombre || '';
            const accion = r.accion || '';
            const timestamp = r.timestamp || '';
            const proyecto = r.proyecto || ''; // Get project name, default to empty string if null/missing

            // --- Add project data cell (td) ---
            html += `<tr>
                        <td>${escapeHtml(nombre)}</td>
                        <td>${escapeHtml(accion)}</td>
                        <td>${escapeHtml(timestamp)}</td>
                        <td>${escapeHtml(proyecto)}</td>
                     </tr>`; // Added <td> for project
          });
          html += "</tbody></table>";
          tablaHistorial.innerHTML = html;
      } catch (error) {
          console.error("Error loading history:", error);
          tablaHistorial.innerHTML = `<div class="alert alert-danger">Error al cargar el historial: ${error.message}</div>`;
      }
    } // End of cargarHistorial

    async function cargarEmpleados() { /* ... keep existing code ... */ }
    async function cargarProyectos() { /* ... keep existing code ... */ }

    // --- Unified Delete Logic ---
    function confirmDeleteItem(buttonElement, itemType) { /* ... keep existing code ... */ }
    async function performDelete(endpoint, name, refreshFunction) { /* ... keep existing code ... */ }

    // --- Form Submission Handling ---
    async function handleFormSubmit(event, endpoint, successMessage, refreshFunction) { /* ... keep existing code ... */ }

    // --- Utility Function ---
    function escapeHtml(unsafe) { /* ... keep existing code ... */ }

    // --- URL Hash Handling ---
     function handleUrlHash() { /* ... keep existing code ... */ }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // ... (keep existing initialization code) ...

        // Initial data loads
        cargarHistorial(); // This will now load history including the project column
        cargarEmpleados();
        cargarProyectos();

        // ... (keep existing message handling and hash handling) ...
    });

  </script>
</body>
</html>
